<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-storage-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <title>Document</title>
</head>

<body>
  <main>
    <a href="signup.html">Sign up</a>
    <h1>Welcome <span id="username"></span></h1>
    <div class="row">
      <div class="col-3">
        <h1>Post Product</h1>
        <h1><a href="viewProduct.html">View Product</a></h1>
      </div>
      <div class="col">
        <h1>Post a product</h1>
        <form class="w-75 mx-auto border shadow p-4 rounded" action="">
          <div class="form-group">
            <label for="">Product Name</label>
            <input id="prod_name" type="text" class="form-control py-3 my-3">
          </div>
          <div class="form-group">
            <label for="">Product Price</label>
            <input id="prod_price" type="number" class="form-control py-3 my-3">
          </div>
          <div class="form-group">
            <label for="">Product Image</label>
            <input onchange="pickImg(event)" type="file" class="form-control py-3 my-3">
          </div>
          <div class="form-group">
            <label for="">Product Description</label>
            <textarea id="prod_desc" class="form-control py-3 my-3"></textarea>
          </div>
          <div class="mt-3">
            <button onclick="postProduct(event)" class="btn btn-primary w-100 p-3 fs-2">Post Product</button>
          </div>
        </form>
      </div>
    </div>
  </main>
</body>

</html>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCN8FLqNUozPNzszaFrVzHIvIjwPqoRPO0",
    authDomain: "febuary-firebase.firebaseapp.com",
    projectId: "febuary-firebase",
    storageBucket: "febuary-firebase.appspot.com",
    messagingSenderId: "633527299065",
    appId: "1:633527299065:web:b74ae2112ab9c4b4232b28"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  var storageRef = firebase.storage().ref();
</script>
<script>
  let username = document.getElementById("username")
  function isLoggedIn() {
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        // User is signed in, see docs for a list of available properties
        // https://firebase.google.com/docs/reference/js/v8/firebase.User
        var uid = user.uid;
        console.log(user);
        username.innerHTML = user.displayName
      } else {
        // User is signed out
        console.log("There's no user");
        alert("you're not logged in")
        window.location.href = "login.html"
      }
    });
  }

  isLoggedIn()

  let prod_name = document.getElementById("prod_name");
  let prod_desc = document.getElementById("prod_desc");
  let prod_price = document.getElementById("prod_price");
  let prod_img;

  function pickImg(ev) {
    let file = ev.target.files[0];

    // Create the file metadata
    var metadata = {
      contentType: 'image/jpeg'
    };

    // Upload file and metadata to the object 'images/mountains.jpg'
    var uploadTask = storageRef.child('images/' + file.name).put(file, metadata);

    // Listen for state changes, errors, and completion of the upload.
    uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
      (snapshot) => {
        // Get task progress, including the number of bytes uploaded and the total number of bytes to be uploaded
        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        console.log('Upload is ' + progress + '% done');
        switch (snapshot.state) {
          case firebase.storage.TaskState.PAUSED: // or 'paused'
            console.log('Upload is paused');
            break;
          case firebase.storage.TaskState.RUNNING: // or 'running'
            console.log('Upload is running');
            break;
        }
      },
      (error) => {
        // A full list of error codes is available at
        // https://firebase.google.com/docs/storage/web/handle-errors
        switch (error.code) {
          case 'storage/unauthorized':
            // User doesn't have permission to access the object
            break;
          case 'storage/canceled':
            // User canceled the upload
            break;

          // ...

          case 'storage/unknown':
            // Unknown error occurred, inspect error.serverResponse
            break;
        }
      },
      () => {
        // Upload completed successfully, now we can get the download URL
        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
          console.log('File available at', downloadURL);
          prod_img = downloadURL
        });
      }
    );
  }

  function postProduct(ev) {
    ev.preventDefault();
    // ev.target.innerHTML = "Posting..."
    ev.target.innerHTML = `
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
    `
    db.collection("products").doc().set({
      prod_name: prod_name.value,
      prod_desc: prod_desc.value,
      prod_price: prod_price.value,
      prod_img: prod_img
    })
      .then(() => {
        console.log("Document successfully written!");
        alert("Product posted")
        ev.target.innerHTML = "Post Product"
        window.location.href = "viewProduct.html"
      })
      .catch((error) => {
        console.error("Error writing document: ", error);
        alert("Something went wrong")
      });
  }
  // function pickImg(ev){
  //   let file = ev.target.files[0];
  //   console.log(file);
  //   let reader = new FileReader();
  //   reader.addEventListener()
  // }
</script>